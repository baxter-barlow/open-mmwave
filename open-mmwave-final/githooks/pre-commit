#!/usr/bin/env bash
#
# Pre-commit hook for open-mmwave
# STRICT - all commits go to public repo
# Bypass with: git commit --no-verify (USE SPARINGLY)

set -e

RED='\033[0;31m'
YELLOW='\033[0;33m'
GREEN='\033[0;32m'
NC='\033[0m'

ERRORS=0
WARNINGS=0

echo "Running pre-commit checks (open-mmwave)..."
echo ""

STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

if [ -z "$STAGED_FILES" ]; then
	echo "No files staged."
	exit 0
fi

# =============================================================================
# CHECK 0: Author identity (BLOCKING)
# =============================================================================
echo -n "Checking commit author... "

REQUIRED_NAME="baxter-barlow"
CURRENT_NAME=$(git config user.name 2>/dev/null || echo "")

if [ "$CURRENT_NAME" != "$REQUIRED_NAME" ]; then
	echo -e "${RED}FAIL${NC}"
	echo " Current: '$CURRENT_NAME'"
	echo " Required: '$REQUIRED_NAME'"
	echo " Fix: git config user.name \"$REQUIRED_NAME\""
	ERRORS=$((ERRORS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 1: Private files that should be gitignored (BLOCKING)
# =============================================================================
echo -n "Checking for private files... "

PRIVATE_PATTERNS=(
	'^sprr'
	'^swrr'
	'^swru'
	'CODEX_SESSION_PHASE'
	'_SESSION_'
	'\.private\.'
	'^TI_'
)

PRIVATE_FOUND=""
for file in $STAGED_FILES; do
	for pattern in "${PRIVATE_PATTERNS[@]}"; do
		if echo "$file" | grep -qE "$pattern"; then
			PRIVATE_FOUND="$PRIVATE_FOUND\n - $file"
		fi
	done
done

if [ -n "$PRIVATE_FOUND" ]; then
	echo -e "${RED}FAIL${NC}"
	echo -e " Private files staged (should be gitignored):$PRIVATE_FOUND"
	echo ""
	echo " Add to .gitignore and unstage:"
	echo " git reset HEAD <file>"
	ERRORS=$((ERRORS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 2: Vendor references (BLOCKING)
# =============================================================================
echo -n "Checking for vendor references... "

VENDOR_PATTERNS=(
	'[Vv]endor SDK'
	'[Vv]endor documentation'
	'development platform'
	'development platform'
	'sprr[0-9]'
	'swrr[0-9]'
	'swru[0-9]'
)

VENDOR_FOUND=""
for file in $STAGED_FILES; do
	if [ -f "$file" ]; then
		if file "$file" | grep -q text; then
			content=$(git diff --cached -- "$file" 2>/dev/null || true)
			for pattern in "${VENDOR_PATTERNS[@]}"; do
				matches=$(echo "$content" | grep -E "$pattern" | head -1 || true)
				if [ -n "$matches" ]; then
					VENDOR_FOUND="$VENDOR_FOUND\n - $file: '$pattern'"
				fi
			done
		fi
	fi
done

if [ -n "$VENDOR_FOUND" ]; then
	echo -e "${RED}FAIL${NC}"
	echo -e " Vendor references found:$VENDOR_FOUND"
	echo ""
	echo " This is a PUBLIC repo. Remove/replace all vendor references."
	echo " Use: 'mmWave frontend', '60GHz transceiver', etc."
	ERRORS=$((ERRORS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 3: Copying language (BLOCKING)
# =============================================================================
echo -n "Checking for copying language... "

COPY_PATTERNS=(
	'\b[Cc]lone\b'
	'[Rr]eplicate.*original'
	'[Cc]opy.*design'
	'[Mm]atch.*original'
	'[Ff]rom.*development platform'
	'[Bb]ased.*on.*original.*board'
)

COPY_FOUND=""
for file in $STAGED_FILES; do
	if [ -f "$file" ]; then
		if file "$file" | grep -q text; then
			content=$(git diff --cached -- "$file" 2>/dev/null || true)
			for pattern in "${COPY_PATTERNS[@]}"; do
				matches=$(echo "$content" | grep -iE "$pattern" | head -1 || true)
				if [ -n "$matches" ]; then
					COPY_FOUND="$COPY_FOUND\n - $file: '$pattern'"
				fi
			done
		fi
	fi
done

if [ -n "$COPY_FOUND" ]; then
	echo -e "${RED}FAIL${NC}"
	echo -e " Copying language found:$COPY_FOUND"
	echo ""
	echo " Reframe as: 'designed', 'developed', 'implemented'"
	ERRORS=$((ERRORS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 4: Secrets (BLOCKING)
# =============================================================================
echo -n "Checking for secrets... "

SECRET_PATTERNS=(
	'AKIA[0-9A-Z]{16}'
	'sk-[a-zA-Z0-9]{48}'
	'sk-ant-[a-zA-Z0-9-]{90,}'
	'ghp_[a-zA-Z0-9]{36}'
	'-----BEGIN.*PRIVATE KEY-----'
	'password\s*=\s*["\x27][^"\x27]{8,}'
)

SECRETS_FOUND=""
for file in $STAGED_FILES; do
	if [ -f "$file" ]; then
		for pattern in "${SECRET_PATTERNS[@]}"; do
			matches=$(git diff --cached -- "$file" | grep -E "$pattern" 2>/dev/null || true)
			if [ -n "$matches" ]; then
				SECRETS_FOUND="$SECRETS_FOUND\n - $file"
				break
			fi
		done
	fi
done

if [ -n "$SECRETS_FOUND" ]; then
	echo -e "${RED}FAIL${NC}"
	echo -e " Secrets found:$SECRETS_FOUND"
	ERRORS=$((ERRORS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 5: Large files (BLOCKING >1MB)
# =============================================================================
echo -n "Checking for large files (>1MB)... "

LARGE_FILES=""
for file in $STAGED_FILES; do
	if [ -f "$file" ]; then
		size=$(wc -c < "$file" 2>/dev/null || echo 0)
		if [ "$size" -gt 1048576 ]; then
			LARGE_FILES="$LARGE_FILES\n - $file ($(numfmt --to=iec $size 2>/dev/null || echo "${size}B"))"
		fi
	fi
done

if [ -n "$LARGE_FILES" ]; then
	echo -e "${RED}FAIL${NC}"
	echo -e " Large files:$LARGE_FILES"
	echo " Use Git LFS or exclude from repo"
	ERRORS=$((ERRORS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 6: AI comment patterns (WARNING)
# =============================================================================
echo -n "Checking for AI patterns... "

AI_PATTERNS=('# This function' '// This function' '# Note that' '// Note that' 'might potentially' 'could potentially')
AI_FOUND=""

for file in $STAGED_FILES; do
	if [ -f "$file" ]; then
		ext="${file##*.}"
		if echo "c h py js md" | grep -qw "$ext"; then
			for pattern in "${AI_PATTERNS[@]}"; do
				matches=$(git diff --cached -- "$file" | grep -iE "^\+.*$pattern" 2>/dev/null | head -1)
				if [ -n "$matches" ]; then
					AI_FOUND="$AI_FOUND\n - $file"
					break
				fi
			done
		fi
	fi
done

if [ -n "$AI_FOUND" ]; then
	echo -e "${YELLOW}WARN${NC}"
	echo -e " AI patterns:$AI_FOUND"
	WARNINGS=$((WARNINGS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 7: Indentation (WARNING)
# =============================================================================
echo -n "Checking indentation... "

INDENT_VIOLATIONS=""
for file in $STAGED_FILES; do
	if [ -f "$file" ]; then
		ext="${file##*.}"
		if echo "c h py" | grep -qw "$ext"; then
			space_indent=$(git diff --cached -- "$file" | grep -E '^\+ [^ ]' | head -1)
			if [ -n "$space_indent" ]; then
				INDENT_VIOLATIONS="$INDENT_VIOLATIONS\n - $file"
			fi
		fi
	fi
done

if [ -n "$INDENT_VIOLATIONS" ]; then
	echo -e "${YELLOW}WARN${NC}"
	echo -e " Use tabs:$INDENT_VIOLATIONS"
	WARNINGS=$((WARNINGS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 8: Marketing language (WARNING)
# =============================================================================
echo -n "Checking for marketing fluff... "

MARKETING=('blazingly' 'seamless' 'cutting-edge' 'state-of-the-art' 'revolutionary' 'game-changing')
MARKETING_FOUND=""

for file in $STAGED_FILES; do
	if [[ "$file" =~ \.(md|txt|rst)$ ]] && [ -f "$file" ]; then
		for term in "${MARKETING[@]}"; do
			if git diff --cached -- "$file" | grep -qiE "^\+.*$term"; then
				MARKETING_FOUND="$MARKETING_FOUND\n - $file: '$term'"
			fi
		done
	fi
done

if [ -n "$MARKETING_FOUND" ]; then
	echo -e "${YELLOW}WARN${NC}"
	echo -e " Marketing fluff:$MARKETING_FOUND"
	WARNINGS=$((WARNINGS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 9: KiCad backups (WARNING)
# =============================================================================
echo -n "Checking for KiCad temp files... "

KICAD_TEMPS=""
for file in $STAGED_FILES; do
	if [[ "$file" =~ -backups/ ]] || [[ "$file" =~ \.kicad_prl$ ]] || [[ "$file" =~ ~$ ]] || [[ "$file" =~ fp-info-cache ]]; then
		KICAD_TEMPS="$KICAD_TEMPS\n - $file"
	fi
done

if [ -n "$KICAD_TEMPS" ]; then
	echo -e "${YELLOW}WARN${NC}"
	echo -e " KiCad temp files:$KICAD_TEMPS"
	echo " Add to .gitignore"
	WARNINGS=$((WARNINGS + 1))
else
	echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# SUMMARY
# =============================================================================
echo ""
echo "----------------------------------------"

if [ $ERRORS -gt 0 ]; then
	echo -e "${RED}BLOCKED: $ERRORS error(s)${NC}"
	echo ""
	echo "This is a PUBLIC repository. Fix issues before committing."
	echo " • Remove vendor references"
	echo " • Remove copying language"
	echo " • Ensure private files are gitignored"
	exit 1
fi

if [ $WARNINGS -gt 0 ]; then
	echo -e "${YELLOW}PASSED with $WARNINGS warning(s)${NC}"
else
	echo -e "${GREEN}All checks passed${NC}"
fi

exit 0
